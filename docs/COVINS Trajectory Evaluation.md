# COVINS Trajectory Evaluation with evo

This README documents the evaluation process for multi-agent SLAM trajectories generated by COVINS, using the [evo](https://github.com/MichaelGrupp/evo) tool. It includes instructions for exporting trajectories, converting and synchronizing ground truth, running evaluations, and interpreting results.

---

## üì§ Output Files

COVINS automatically saves each agent's estimated trajectory in:

```
covins_backend/output/KF_<AGENT_ID>_<FORMAT>.csv
```

You can copy them from Docker with:

```bash
docker cp <container_id>:/root/covins_ws/src/covins/covins_backend/output /host/path/to/output
```

### Supported Formats

Set via `trajectory_format` in `config_backend.yaml`:

* **TUM format** (default):
  `timestamp[s] t_x t_y t_z q_x q_y q_z q_w`
* **EuRoC format**:
  `timestamp[ns], t_x, t_y, t_z, q_w, q_x, q_y, q_z, vel_x, vel_y, vel_z, bias_gyro_*, bias_acc_*`

Output files include suffixes `_ftum.csv` or `_feuroc.csv`.

### Combining Trajectories

* Combine multiple agents into one estimate:

  ```bash
  cat KF_0_ftum.csv KF_1_ftum.csv KF_2_ftum.csv > mh123_est.csv
  ```
* Or use the combined file:
  `stamped_traj_estimate.txt`

### Ground Truth

* Located in: `<sequence>/mav0/state_groundtruth_estimate0/data.csv`
* Merge multiple GT files manually (remove duplicate headers).

---

## üìê Evaluation with `evo`


### Evaluate with APE (Absolute Pose Error)

#### üìä Result Interpretation

What do these metrics mean?

| Metric     | Description                                          |
| ---------- | ---------------------------------------------------- |
| **Max**    | Worst-case translation error (in meters)             |
| **Mean**   | Average translation error across all timestamps      |
| **Median** | Middle error value ‚Äì robust to outliers              |
| **Min**    | Best-case accuracy (lowest error observed)           |
| **RMSE**   | Root Mean Square Error ‚Äì balances large/small errors |
| **Std**    | Standard deviation ‚Äì how much the error varies       |


#### üîπ Without GBA:

```bash
evo_ape euroc mh123_gt.csv mh123_est.csv -va --save_results results/without_gba.zip --plot
```
| Metric | Value (m) |
| ------ | --------- |
| Max    |  0.1529 m |
| Mean   | 0.0639 m  |
| Median | 0.0611 m  |
| Min    | 0.0067 m  |
| Std    | 0.0286 m  |


![Screenshot from 2025-05-08 10-38-31](https://github.com/user-attachments/assets/7742a991-09ad-48a4-b366-1b72f2d3c753)
![image](https://github.com/user-attachments/assets/6f542768-4b33-442a-a6d7-98bf0a21888f)
This 3D plot visualizes the Absolute Pose Error (APE) along the estimated trajectory, with color indicating the magnitude of translation error. Most of the trajectory appears in deep blue to cyan (error < 8 cm), suggesting high spatial accuracy. A few localized segments in yellow and red indicate slightly higher deviations (up to ~15 cm), often in areas with sharp turns or less visual information. The smooth, symmetric loops and overall compact error distribution reflect the strong performance of the global bundle adjustment.

#### üîπ With GBA:

```bash
evo_ape euroc mh123_gt.csv mh123_est_gba.csv -va --save_results results/with_gba.zip --plot
```
| Metric | Value (m) |
| ------ | --------- |
| Max    |  0.1065 m |
| Mean   | 0.0199 m  |
| Median | 0.0174 m  |
| Min    |  0.0028 m |
| RMSE   | 0.0227 m  |
| Std    | 0.0108 m  |


![Screenshot from 2025-05-08 11-13-40](https://github.com/user-attachments/assets/ca26a449-7f5f-45c9-b6eb-84ab76438103)
![image](https://github.com/user-attachments/assets/aa1cc3ce-2211-4c7d-a969-27439538878e)
In this 3D error map, the estimated trajectory closely follows the reference, with most segments appearing in dark blue (APE < 5 cm). The color scale indicates a significantly reduced error range compared to the version without GBA. Minimal presence of green or yellow highlights suggests that global bundle adjustment successfully minimized drift and aligned the trajectory consistently throughout the entire sequence.


#### compare results:
```evo_res results/*.zip -p --save_table results/table.csv```
üìä Comparison Table

| File                | RMSE   | Mean   | Median | Std    | Min    | Max    | SSE    |
| ------------------- | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| mh123\_est.csv      | 0.0700 | 0.0639 | 0.0611 | 0.0286 | 0.0067 | 0.1529 | 1.4707 |
| mh123\_est\_gba.csv | 0.0228 | 0.0200 | 0.0175 | 0.0109 | 0.0029 | 0.1066 | 0.3677 |

> üîç The results clearly show that enabling GBA reduces the mean APE from 6.4 cm to 2.0 cm, and the RMSE from 7 cm to 2.3 cm ‚Äî significantly improving global consistency.

![image](https://github.com/user-attachments/assets/e30e18df-e9aa-47e5-8e8c-153a111851c5)


### üß™ Comparison: Independent Agents vs. Multi-Agent COVINS

To assess the contribution of collaborative mapping in COVINS, we evaluated three agents separately, without merging their maps. Each trajectory was aligned and compared independently, and their results were averaged.

#### üìä APE Results (Averaged across independent agents):

| Metric | Value (m) |
|--------|-----------|
| RMSE   | 0.0932    |
| Mean   | 0.0859    |
| Median | 0.0774    |
| Std    | 0.0358    |
| Min    | 0.0245    |
| Max    | 0.1805    |
| SSE    | 1.2151    |

#### üìä Comparison Table

| Configuration              | RMSE   | Mean   | Median | Std    | Min    | Max    | SSE    |
|----------------------------|--------|--------|--------|--------|--------|--------|--------|
| Independent Agents (avg)   | 0.0932 | 0.0859 | 0.0774 | 0.0358 | 0.0245 | 0.1805 | 1.2151 |
| Multi-Agent (no GBA)       | 0.0700 | 0.0639 | 0.0611 | 0.0286 | 0.0067 | 0.1529 | 1.4707 |
| Multi-Agent with GBA       | **0.0228** | **0.0200** | **0.0175** | **0.0109** | **0.0029** | **0.1066** | **0.3677** |

üîç **Conclusion:**  
Multi-agent mapping in COVINS significantly reduces pose estimation error compared to independent agents, particularly when using GBA. RMSE dropped from ~9.3 cm (no collaboration) to ~2.3 cm with GBA ‚Äî a ~75% improvement in accuracy.


## üìä Multi-Agent GBA Comparison: Every 50 KF vs Once at the End

### üß™ GBA Only Once at the End
| GBA # | KF Count | LM Count Before | LM Included | LM Removed | Removal Reason | Notes                     |
|-------|----------|------------------|--------------|-------------|------------------|----------------------------|
| Final | 425      | 12915            | 12857        | 58          | map checks       | Single GBA after full run |

#### üîÅ GBA Every 50 KF

| GBA # | KF Count | LM Count Before | LM Included | LM Removed | Removal Reason         | Notes                              |
|-------|----------|------------------|--------------|-------------|-------------------------|-------------------------------------|
| 1     | 59       | 2602             | 2515         | 87          | map checks              | After first 50 KF                  |
| 2     | 165      | 6722             | 6505         | 217         | map checks              | After 150 KF + map merges          |
| 3     | 218      | 8112             | 8013         | 99          | map checks              | After 200 KF                       |
| 4     | 268      | 9839             | 9638         | 201         | map checks              | After 250 KF                       |
| 5     | 325      | 11215            | 11154        | 61          | map checks              | After 300 KF                       |
| 6     | 386      | 12325            | 12277        | 48          | map checks              | After 350 KF                       |
| 7     | 440      | 13319            | 13252        | 67          | map checks              | After 400 KF + several PGOs        |


### results:

### covins-G :
gba ones:
![gba_once_catKF](https://github.com/user-attachments/assets/ebbdb936-f65d-4d17-b65f-9080e3c85903)

gba every 50 kf:
![gba_50_kf_catKF](https://github.com/user-attachments/assets/766ccc92-c38f-4eb0-b460-261144f21783)

#### compare results:
```evo_res results/*.zip -p --save_table results/table.csv```
üìä Comparison Table

| File                | RMSE    | Mean    | Median  | Std     | Min     | Max     | SSE     |
|---------------------|---------|---------|---------|---------|---------|---------|----------|
| GBA Once at End     | 0.0364  | 0.0314  | 0.0273  | 0.0185  | 0.0043  | 0.0929  | 0.5635   |
| GBA Every 50 KF     | 0.0404  | 0.0360  | 0.0356  | 0.0184  | 0.0028  | 0.1155  | 0.7194   |

### üìå Key Observations
- GBA Once has **slightly lower RMSE and Mean error**, indicating marginally better global accuracy.
- GBA Every 50 KF provides **ongoing cleaning**, which may help in dynamic or large-scale multi-agent scenarios.
- Standard deviation is nearly identical, suggesting similar consistency across both runs.

### covins:
gba ones:
![Screenshot from 2025-05-18 14-15-57](https://github.com/user-attachments/assets/cebd598a-ee2b-47c4-bd22-14cec3e8b6fb)

gba every 50 kf:
![Screenshot from 2025-05-18 14-13-34](https://github.com/user-attachments/assets/4178fe4f-9006-40db-8e0d-bfafc2acff8b)


## üìå Summary

* Estimated trajectories must be in **TUM** format for `evo_ape`.
* Ground truth can be in **EuRoC** or **TUM**.
* Use `--align --correct_scale` to compensate for initialization and scale drift.
* Sync timestamps carefully for  visualization.
* Use `evo_res` for batch comparisons.

---

üìÇ For visual examples and screenshots, refer to the attached image assets in this repo.

---
